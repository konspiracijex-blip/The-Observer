<!DOCTYPE html>
<html lang="sr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>OBSERVER - NIVO 1</title>

    <link href="https://fonts.googleapis.com/css2?family=Press+Start+2P&display=swap" rel="stylesheet">

    <style>
        /* Retro Terminal CSS */
        body {
            background-color: #000000;
            color: #00FF00;
            font-family: 'Press Start 2P', 'Courier New', monospace;
            font-size: 16px; 
            margin: 0;
            padding: 20px;
            height: 100vh;
            overflow-y: auto;
            text-shadow: 0 0 5px rgba(0, 255, 0, 0.7), 0 0 10px rgba(0, 255, 0, 0.3);
            position: relative;
        }

        .terminal {
            width: 100%;
            max-width: 800px;
            margin: 0 auto;
            box-sizing: border-box;
            white-space: pre-wrap; 
            min-height: 100vh;
        }
        
        @keyframes red-flash {
            0% { background-color: #000000; }
            50% { background-color: #FF0000; }
            100% { background-color: #000000; }
        }

        .flash-red { animation: red-flash 0.3s ease-out 1; }

        @keyframes text-flash {
            0% { opacity: 1; }
            50% { opacity: 0.1; }
            100% { opacity: 1; }
        }

        .fail-flash {
            color: #FF0000;
            font-weight: bold;
            animation: text-flash 0.5s step-start infinite;
        }

        /* NOVO: Blinking efekat za gašenje i poruke uspeha */
        @keyframes green-blink {
            0% { opacity: 1; }
            50% { opacity: 0.2; }
            100% { opacity: 1; }
        }

        .shutdown-message, .success-message {
            color: #00FF00;
            font-size: 1.5em; 
            text-align: center;
            padding-top: 45vh;
            text-shadow: 0 0 5px rgba(0, 255, 0, 0.7), 0 0 10px rgba(0, 255, 0, 0.3);
        }

        .shutdown-message {
            animation: green-blink 1s step-start infinite;
        }

        /* Sekvence poruka (boot, shutdown) */
        #boot-sequence {
            text-align: center;
            font-size: 0.9em;
            border-bottom: 1px solid rgba(0, 255, 0, 0.1);
            padding-bottom: 15px;
            margin-bottom: 15px;
        }
        
        /* Novi div za sekvencu gašenja koji koristi isti stil */
        #shutdown-terminal-sequence {
            /* Osiguravamo da nema min-height iz terminal klase */
            min-height: auto; 
            padding: 20px;
            margin-top: 50px; /* Mali razmak od vrha */
            text-align: left;
            font-size: 0.9em;
        }
        #shutdown-terminal-sequence p {
            margin: 0;
            padding: 0;
            line-height: 1.5;
            text-align: center;
        }


        .game-title {
            font-size: 3.2em; 
            color: #FF0000;
            text-align: center;
            margin-bottom: 15px; 
            text-shadow: 0 0 10px rgba(255, 0, 0, 0.7), 0 0 20px rgba(255, 0, 0, 0.5);
            font-weight: bold;
        }

        .system-info {
            font-size: 0.9em;
            color: #00FF00;
            text-align: center;
            margin-top: 5px; 
            margin-bottom: 30px; 
        }

        /* KRITIČNA KOREKCIJA: Uklanjamo apsolutno pozicioniranje koje uzrokuje skok */
        #hidden-input {
            opacity: 0;
            position: fixed; /* Fixed ili absolute van vidljivog dela */
            left: -9999px;
            top: -9999px;
            width: 1px;
            height: 1px;
            padding: 0;
            margin: 0;
            border: none;
            overflow: hidden;
        }

        #user-input-display { display: inline; }
        
        /* Novi div za tekst Levela 2 i Levela 3 - Uklonjen min-height 400px */
        #level2-text {
            white-space: pre-wrap;
            text-align: left;
            margin: 20px auto 40px auto;
            max-width: 80%;
            line-height: 1.8;
            /* min-height je sada regulisan klasom 'level-2-space' */
        }
        
        /* NOVA KLASA: Postavlja min-height 400px SAMO za Nivo 2 (dugački tekst) */
        .level-2-space {
            min-height: 400px;
        }

        /* Za poslednju liniju sa pitanjem */
        .level2-question {
            font-weight: bold;
            margin-top: 30px;
            display: block;
            /* NOVA IZMENA V8: Uklanjanje text-shadow-a */
            text-shadow: none; 
        }


        /* V10 KOREKCIJA: Poravnanje inputa levo i centriranje bloka, da prati #level2-text */
        .input-row {
            display: flex;
            flex-direction: column;
            align-items: flex-start; 
            margin: 8px auto 0 auto; 
            max-width: 80%; 
        }

        .input-row .visible-input {
            display: inline-flex;
            align-items: center;
            gap: 8px;
        }

        .messages-row {
            text-align: center;
            margin-top: 12px;
        }

        /* Improved formatting for wrapped messages */
        #feedback-fail {
            display: block;
            margin: 4px auto; /* Centriranje bloka */
            white-space: pre; 
            line-height: 1.6;
            max-width: 90%;
            text-align: center; /* Centriranje teksta unutar bloka (ovo se menja u JS za hint) */
            font-size: 0.8em; 
        }
        
        #feedback-success {
            display: block;
            margin: 4px 0;
            white-space: pre-wrap;
            line-height: 1.6;
            word-break: break-word;
            max-width: 90%;
            margin-left: auto;
            margin-right: auto;
            text-align: center;
        }


        .cursor {
            background-color: #00FF00;
            color: #000000;
            display: inline-block;
            width: 8px;
            animation: blink 1s step-start infinite;
        }
        @keyframes blink { 50% { opacity: 0; } }

        .hidden { display: none; }

        @media (max-width: 600px) {
            body { font-size: 12px; padding: 10px; }
            .game-title { font-size: 1.6em; }
            .system-info { font-size: 0.8em; }
            .cursor { width: 6px; }
            #feedback-fail { font-size: 0.9em; } 
            #level2-text { max-width: 100%; min-height: 300px; }
        }
    </style>
</head>
<body>

    <div class="terminal" id="terminal-container">
        <div id="boot-sequence"></div> 

        <div id="game-content" class="hidden">
            <div class="game-title">OBSERVER</div>
            <div class="system-info">SISTEM 1101 / VER. 2.6</div>

            <div id="level2-text" class="hidden"></div>

            <div class="input-row" id="current-input-row">
                <span class="visible-input"><span id="input-prompt-text">Unesite šifru:</span> <span id="user-input-display"></span><span class="cursor" id="fake-cursor">_</span></span>

                <div class="messages-row">
                    <div id="feedback-success" class="hidden"></div>
                    <div id="feedback-fail" class="hidden"></div>
                </div>
            </div>
            
        </div>
    </div>
    
    <input type="text" id="hidden-input" autofocus
           inputmode="text" enterkeyhint="done"
           autocorrect="off" autocapitalize="characters" spellcheck="false" autocomplete="off">


    <script>
        document.addEventListener('DOMContentLoaded', () => {
            const terminalContainer = document.getElementById('terminal-container');
            const bootSequenceDiv = document.getElementById('boot-sequence');
            const gameContentDiv = document.getElementById('game-content');
            const hiddenInput = document.getElementById('hidden-input');
            const displayDiv = document.getElementById('user-input-display');
            const fakeCursor = document.getElementById('fake-cursor');
            const failDiv = document.getElementById('feedback-fail');
            const successDiv = document.getElementById('feedback-success');
            const gameTitle = document.querySelector('.game-title');
            const systemInfo = document.querySelector('.system-info');
            const currentInputRowEl = document.getElementById('current-input-row');
            const inputPromptText = document.getElementById('input-prompt-text');
            const level2TextDiv = document.getElementById('level2-text');

            // NIVO 1 KONSTANTE
            const CORRECT_ANSWERS = ['OBSERVER', 'POSMATRAC'];
            const BOOT_DELAY_MS = 300; 
            const MAX_ATTEMPTS = 5;
            
            // NIVO 1 HINT KONSTANTE
            const HINT_TRIGGERS = ['POMOC', 'HELP']; 
            const HINT_TEXT = "Postojim na obe strane stakla i u onome<br>što se gleda i u onome ko gleda.";

            // NIVO 2 KONSTANTE
            const LEVEL_2_TEXT = "Svuda oko tebe vidljivi zidovi, nevidljive brave.<br>Svet u kojem živiš nije onaj koji misliš da poznaješ.<br>Ljudi spavaju, veruju ono što im je rečeno, a ne ono što mogu sami da otkriju.<br>Zato ti postavljam pitanje.<br>Da li si posmatrač ili učesnik?<br>Da li si još jedan broj u sistemu koji te koristi Ili si spreman da pronađeš istinu u matrici i prođeš kroz nju?<br>Ako želiš istinu, moraćeš da je zaslužiš.<br>Prva zagonetka te čeka. Vrata će se otvoriti samo onima koji razumeju skriveni jezik.";

            // NOVE KONSTANTE ZA NIVO 3 (ZAGONETKU)
            const CORRECT_ANSWER_LEVEL_3 = ['KAMERA', 'KAMERE']; 
            const LEVEL_3_RIDDLE_TEXT = "Ona te posmatra, ali nikad te ne vidi. Ko je ona?";
            
            // NOVE KONSTANTE ZA NIVO 3 HINT (V10)
            const HINT_TRIGGERS_LEVEL_3 = ['POMOC', 'HELP']; 
            const HINT_TEXT_LEVEL_3 = "Zna svaki tvoj pokret, ali ne postoje oči koje gledaju.";
            
            // NOVE PORUKE ZA PRELAZAK NA NIVO 3
            const LEVEL_3_TRANSITION_MESSAGES = [
                'ACCESS GRANTED: MATRIX LAYER 1',
                'INITIATING DECRYPTION PROTOCOL: PYLON 3',
                'SYSTEM RECALIBRATION... COMPLETE',
                'ESTABLISHING SECURE CONNECTION TO ORACLE...',
                'WARNING: PARADOX DETECTED (OBSERVER/PARTICIPANT)',
                'LOADING TRUTH ALGORITHM: A-3',
                'LEVEL 3 ACCESS: GRANTED',
                'AWAITING RIDDLE ANSWER...'
            ];

            // NOVE PORUKE ZA MINI BOOT NIVO 4 (V5 DODATAK)
            const LEVEL_4_TRANSITION_MESSAGES = [
                'RIDDLE SOLVED: CAMERA MODULE ACTIVATED',
                'DECRYPTING ORACLE PYLON 4...',
                'ACCESSING HIDDEN REALITY DATA...',
                'PREPARING USER FOR DEEPER INSIGHT...',
                'LEVEL 4 TRANSITION INITIATED.'
            ];
            
            // NOVE PORUKE ZA GAŠENJE SISTEMA (SHUTDOWN)
            const SHUTDOWN_MESSAGES = [
                'CLOSING ORACLE CONNECTION...',
                'UNLOADING TRUTH ALGORITHM: A-3',
                'REVERTING MATRIX LAYER 1 ACCESS...',
                'WARNING: USER DECLINED PARTICIPATION.',
                'SECURITY PROTOCOL: SHUTDOWN INITIATED',
                'FLUSHING MEMORY...',
                'DISCONNECTING NETWORK... OFFLINE',
                'SYSTEM POWER DOWN SEQUENCE...',
                'STANDBY MODE... ACTIVATED',
                'SYSTEM OFFLINE.'
            ];
            

            let currentInput = "";
            let attemptCount = 0;
            let typingTimer = null;
            let failTimer = null;
            let hintUsedLevel1 = false; // Status hint-a za Nivo 1
            let hintUsedLevel3 = false; // Status hint-a za Nivo 3 (V10)

            let inputListenerLevel1, keypressListenerLevel1;
            let inputListenerLevel2, keypressListenerLevel2;
            let inputListenerLevel3, keypressListenerLevel3; 

            const bootMessages = [
                'CHECKING CORE COMPONENTS...',
                'RAM: 640K OK',
                'HDD: DRIVE C: ACCESS GRANTED',
                'LOADING OBSERVER OS... SISTEM 1101',
                'NETWORK CONNECTION... ONLINE [WANTED]',
                'INITIATING OBSERVER PROTOCOL...',
                'WARNING: ACCESS IS RESTRICTED.',
                'LOADING ENCRYPTION MODULE: ALPHA 1...',
                'CALIBRATING SENSORS... OK',
                'EXECUTING SELF-DIAGNOSTICS: 98%... 100%',
                'SCANNING ENVIRONMENT... SILENT',
                'DATA LINK ESTABLISHED: 73.0.12.91',
                'SYSTEM STATUS: PENDING INPUT',
                'AWAITING USER INPUT...'
            ];
            
            // =================================================================
            // REFACTORING: ZAJEDNIČKA FUNKCIJA ZA KUCANJE PORUKA SEKVENCI
            // =================================================================
            
            /**
             * Pokreće sekvencu kucanja poruka u zadatom kontejneru.
             * @param {HTMLElement} targetDiv Element gde će se poruke kucati.
             * @param {string[]} messages Niz poruka za kucanje.
             * @param {number} index Trenutni indeks poruke.
             * @param {function} callback Funkcija koja se poziva na kraju sekvence.
             */
            function runSequence(targetDiv, messages, index, callback = null) {
                if (index < messages.length) {
                    const line = document.createElement('p');
                    line.textContent = messages[index];
                    
                    // Osigurava da je kontejner vidljiv i dodaje liniju
                    targetDiv.style.display = 'block';
                    targetDiv.appendChild(line);

                    // Skrolovanje unutar DIV-a (za duže sekvence)
                    targetDiv.scrollTop = targetDiv.scrollHeight;

                    setTimeout(() => runSequence(targetDiv, messages, index + 1, callback), BOOT_DELAY_MS);
                } else {
                    targetDiv.style.display = 'none';
                    if (callback) callback();
                }
            }
            
            // =================================================================
            // OSTALE FUNKCIJE KUCANJA TEKSTA I PORUKA
            // =================================================================

            function typeText(targetElement, text, speed, callback = null) {
                if (!targetElement) return;
                targetElement.classList.remove('hidden');
                targetElement.style.display = 'block';
                targetElement.innerHTML = '';
                let i = 0;
                function type() {
                    if (i < text.length) {
                        // Logika za prepoznavanje <br> i &nbsp;
                        if (text.charAt(i) === '<') {
                            const brIndex = text.indexOf('<br>', i);
                            if (brIndex === i) {
                                targetElement.innerHTML += '<br>';
                                i += 4; 
                            } else {
                                targetElement.innerHTML += text.charAt(i);
                                i++;
                            }
                        } else if (text.charAt(i) === '&') { 
                            const nbspIndex = text.indexOf('&nbsp;', i);
                             if (nbspIndex === i) {
                                targetElement.innerHTML += '&nbsp;';
                                i += 6; 
                            } else {
                                targetElement.innerHTML += text.charAt(i);
                                i++;
                            }
                        } else {
                            targetElement.innerHTML += text.charAt(i);
                            i++;
                        }
                        typingTimer = setTimeout(type, speed);
                    } else {
                        if (callback) callback();
                    }
                }
                type();
            }


            function showFailMessage(text, { flash = true, duration = 1000, alignLeft = false } = {}) {
                if (failTimer) { clearTimeout(failTimer); failTimer = null; }
                if (!failDiv) return;
                
                // Vraćanje na standardne stilove pre primene novih
                failDiv.style.textAlign = 'center'; 
                failDiv.style.maxWidth = '90%'; 
                
                // Specijalna poravnanja za hint (ako je potrebno)
                if (alignLeft) {
                    failDiv.style.textAlign = 'left'; 
                    failDiv.style.maxWidth = '80%';
                }
                
                failDiv.innerHTML = text; 
                failDiv.classList.remove('hidden');
                failDiv.style.display = 'block';
                failDiv.classList.toggle('fail-flash', flash);
                
                // Postavljanje boje na zelenu ako nema bljeska, inače crvena
                if (!flash) {
                    failDiv.style.color = '#00FF00'; 
                } else {
                    failDiv.style.color = '#FF0000'; 
                }


                failTimer = setTimeout(() => {
                    // Resetovanje stila i sakrivanje
                    failDiv.classList.remove('fail-flash');
                    failDiv.classList.add('hidden');
                    failDiv.style.display = 'none';
                    failDiv.innerHTML = ''; 
                    failDiv.style.color = '#00FF00'; // Resetovanje boje na zelenu za sledeće poruke
                    
                    // Osiguravamo da se resetuju stilske izmene iz drugih delova koda
                    failDiv.style.textAlign = 'center'; 
                    failDiv.style.maxWidth = '90%'; 
                    
                    failTimer = null;
                }, duration);
            }
            
            function accessGranted() {
                // Uklanja elemente Nivoa 1
                currentInputRowEl.classList.add('hidden');
                successDiv.classList.add('hidden');
                
                // AŽURIRANA LINIJA ZA LEVEL 2 PODNASLOV
                systemInfo.textContent = 'PRISTUP ODOBREN / NIVO PRISTUPA A2';

                // Prelazak na Level 2
                setTimeout(startLevel2, 300);
            }
            
            function startLevel2() {
                // Skrivanje elemenata Nivoa 1
                gameContentDiv.classList.remove('hidden');
                currentInputRowEl.classList.remove('hidden');
                
                // Onemogućava unos dok se tekst kuca
                hiddenInput.disabled = true;
                if (fakeCursor) fakeCursor.style.display = 'none';
                
                // Uklanjanje slušaoca Nivoa 1
                hiddenInput.removeEventListener('input', inputListenerLevel1);
                hiddenInput.removeEventListener('keydown', keypressListenerLevel1);
                
                // Priprema za kucanje teksta Nivoa 2
                level2TextDiv.innerHTML = '';
                level2TextDiv.classList.remove('hidden');
                
                // V12 FIX: Dodaje klasu za min-height 400px
                level2TextDiv.classList.add('level-2-space'); 
                
                currentInputRowEl.style.display = 'none'; // Sakrivanje input reda dok traje kucanje

                // Kuca tekst Nivoa 2
                // IZMENA: Brzina kucanja smanjena sa 50 na 20 ms
                typeText(level2TextDiv, LEVEL_2_TEXT, 20, () => {
                    // Dodaje pitanje i input nakon što je tekst iskucan
                    const questionPrompt = document.createElement('span');
                    questionPrompt.className = 'level2-question';
                    questionPrompt.innerHTML = '<br><br>Da li si spreman DA/NE?';
                    level2TextDiv.appendChild(questionPrompt);

                    // Brisanje prethodne šifre
                    currentInput = '';
                    displayDiv.textContent = '';
                    hiddenInput.value = '';

                    // Prikazuje red za unos sa novim promptom
                    inputPromptText.textContent = 'Izbor:'; 
                    currentInputRowEl.style.display = 'flex';
                    
                    // Omogućava unos
                    hiddenInput.disabled = false;
                    if (fakeCursor) fakeCursor.style.display = 'inline-block';
                    
                    // KOREKCIJA SKROLOVANJA: Skrolujemo tako da input bude vidljiv, a naslov ostane.
                    const scrollTargetLevel2 = currentInputRowEl.offsetTop - (window.innerHeight / 3);
                    window.scrollTo(0, scrollTargetLevel2 > 0 ? scrollTargetLevel2 : 0);
                    
                    // Fokusiramo bez skrolovanja (jer smo već skrolovali)
                    hiddenInput.focus({ preventScroll: true }); 

                    // Dodavanje slušaoca Nivoa 2
                    hiddenInput.addEventListener('input', inputListenerLevel2);
                    hiddenInput.addEventListener('keydown', keypressListenerLevel2);
                });
            }
            
            
            function loadLevel3WithBootSequence() {
                // 1. Uklanjanje svih dinamičkih elemenata sa ekrana (pre "UČITAVAM" poruke)
                gameContentDiv.classList.add('hidden'); 
                level2TextDiv.innerHTML = '';
                level2TextDiv.classList.add('hidden');
                currentInputRowEl.style.display = 'none';
                
                // 2. Kreiranje i prikaz "UČITAVAM" poruke na sredini
                const loadingDiv = document.createElement('div');
                loadingDiv.id = 'loading-message';
                loadingDiv.textContent = 'UČITAVAM';
                loadingDiv.style.color = '#00FF00';
                loadingDiv.style.fontFamily = 'Press Start 2P';
                loadingDiv.style.fontSize = '1.5em'; 
                loadingDiv.style.textAlign = 'center';
                loadingDiv.style.paddingTop = '45vh'; 
                loadingDiv.style.height = '100vh'; 
                loadingDiv.style.position = 'fixed';
                loadingDiv.style.width = '100%';
                loadingDiv.style.top = '0';
                loadingDiv.style.left = '0';
                loadingDiv.style.backgroundColor = 'black'; 
                loadingDiv.style.textShadow = '0 0 5px rgba(0, 255, 0, 0.7), 0 0 10px rgba(0, 255, 0, 0.3)';

                terminalContainer.style.display = 'none'; 
                document.body.appendChild(loadingDiv);
                window.scrollTo(0, 0); 

                // 3. Čekanje i pokretanje nove boot sekvence
                setTimeout(() => {
                    // 3a. Uklanjanje "UČITAVAM"
                    document.body.removeChild(loadingDiv);

                    // 3b. PRVO POTPUNO ČIŠĆENJE EKRANA (Step 2 - Briše SVE)
                    const oldTerminalContainer = terminalContainer;
                    const oldHiddenInput = hiddenInput;
                    document.body.innerHTML = '';
                    
                    // Vraćanje osnovne strukture
                    document.body.appendChild(oldTerminalContainer);
                    document.body.appendChild(oldHiddenInput); 
                    
                    // Vraćanje na osnovni body stil
                    document.body.style.backgroundColor = 'black';
                    document.body.style.color = '#00FF00';
                    document.body.style.overflow = 'auto';
                    document.body.style.textShadow = '0 0 5px rgba(0, 255, 0, 0.7), 0 0 10px rgba(0, 255, 0, 0.3)';

                    oldTerminalContainer.style.display = 'block';
                    
                    // Pokretanje nove boot sekvence
                    bootSequenceDiv.style.display = 'block';
                    bootSequenceDiv.innerHTML = ''; 
                    gameContentDiv.classList.add('hidden'); // Održavamo skrivenim tokom boot-a
                    
                    // Postavljanje Level 3 podnaslova
                    systemInfo.textContent = 'PRISTUP ODOBREN / NIVO PRISTUPA A3';
                    
                    window.scrollTo(0, 0); 

                    // Korišćenje LEVEL_3_TRANSITION_MESSAGES. Callback će pokrenuti startLevel3()
                    runSequence(bootSequenceDiv, LEVEL_3_TRANSITION_MESSAGES, 0, () => {
                        // 4. DRUGO POTPUNO ČIŠĆENJE EKRANA (Step 4 - Briše boot poruke i čisti za Level 3)
                        
                        // Uklanjamo boot poruke
                        bootSequenceDiv.style.display = 'none';
                        bootSequenceDiv.innerHTML = '';
                        
                        // Re-aktivacija game content-a (naslov i sistem info)
                        gameContentDiv.classList.remove('hidden'); 

                        // 5. Pokretanje Level 3 zagonetke
                        startLevel3();
                    });
                }, 1000); // Pauza za "UČITAVAM"
            }
            
            // =================================================================
            // SEKVENCA GAŠENJA SISTEMA
            // =================================================================
            function startShutdownSequence() {
                // 1. Onemogućavanje unosa
                hiddenInput.disabled = true;
                if (fakeCursor) fakeCursor.style.display = 'none';
                hiddenInput.removeEventListener('input', inputListenerLevel2);
                hiddenInput.removeEventListener('keydown', keypressListenerLevel2);

                // 2. Čišćenje i prikaz poruke za gašenje (blinkanje)
                gameContentDiv.classList.add('hidden'); 
                level2TextDiv.innerHTML = '';
                level2TextDiv.classList.add('hidden');
                currentInputRowEl.style.display = 'none';
                terminalContainer.style.display = 'none'; // Sakrivanje celog terminala
                
                window.scrollTo(0, 0); 
                
                const shutdownTextDiv = document.createElement('div');
                shutdownTextDiv.id = 'shutdown-blinking';
                shutdownTextDiv.textContent = 'SISTEM SE GASI';
                shutdownTextDiv.className = 'shutdown-message'; 
                shutdownTextDiv.style.position = 'fixed';
                shutdownTextDiv.style.width = '100%';
                shutdownTextDiv.style.height = '100%';
                shutdownTextDiv.style.backgroundColor = 'black'; 
                shutdownTextDiv.style.zIndex = '10'; 
                
                document.body.appendChild(shutdownTextDiv);

                // 3. Pokretanje sekvence gašenja nakon blinkanja
                setTimeout(() => {
                    // 3a. Uklanjanje poruke i POTPUNO BRISANJE EKRANA 
                    document.body.removeChild(shutdownTextDiv);
                    document.body.innerHTML = ''; // BRISE SVE OSTALO SA BODY-ja
                    
                    // 3b. Postavljanje body stila za prikaz sekvence
                    document.body.style.backgroundColor = 'black';
                    document.body.style.color = '#00FF00';
                    document.body.style.overflow = 'auto';
                    document.body.style.textShadow = '0 0 5px rgba(0, 255, 0, 0.7), 0 0 10px rgba(0, 255, 0, 0.3)';
                    window.scrollTo(0, 0); // Vrh ekrana

                    // 3c. Kreiranje posvećenog kontejnera za poruke sekvence
                    const shutdownTerminalSequence = document.createElement('div');
                    shutdownTerminalSequence.id = 'shutdown-terminal-sequence';
                    document.body.appendChild(shutdownTerminalSequence);
                    
                    // 4. Pokretanje sekvence gašenja unutar novog kontejnera
                    runSequence(shutdownTerminalSequence, SHUTDOWN_MESSAGES, 0, () => {
                        // 5. Gašenje ekrana na crno
                        
                        // Sakrivanje celog body sadržaja (poruke su gotove)
                        document.body.innerHTML = '';
                        
                        // Postavljanje celog body na crno bez teksta/scroll-a
                        document.body.style.backgroundColor = 'black';
                        document.body.style.color = 'black';
                        document.body.style.overflow = 'hidden';
                        document.body.style.textShadow = 'none'; 
                    });
                }, 1500); // Vreme prikaza poruke "SISTEM SE GASI"
            }


            // =================================================================
            // NIVO 3 LOGIKA - ZAGONETKA (V10: DODAT HINT)
            // =================================================================

            function startLevel3() {
                // Uklanjanje slušaoca Nivoa 2
                hiddenInput.removeEventListener('input', inputListenerLevel2);
                hiddenInput.removeEventListener('keydown', keypressListenerLevel2);
                
                // Čišćenje samo dinamičkog sadržaja i poruka
                successDiv.classList.add('hidden');
                successDiv.innerHTML = '';
                currentInputRowEl.style.display = 'none';
                level2TextDiv.innerHTML = ''; // Potpuno brisanje starog teksta
                
                // Uklanjamo klasu za min-height 400px kako bi se polje podiglo
                level2TextDiv.classList.remove('level-2-space'); 
                
                // Prikazujemo game content nakon boot sekvence (gameContentDiv je već vidljiv iz callback-a)
                
                // Kuca tekst Nivoa 3
                typeText(level2TextDiv, LEVEL_3_RIDDLE_TEXT, 50, () => {
                    
                    // Priprema input za Nivo 3
                    currentInput = '';
                    displayDiv.textContent = '';
                    hiddenInput.value = '';
                    inputPromptText.textContent = 'ODGOVOR:'; // Novi prompt
                    currentInputRowEl.style.display = 'flex';
                    
                    // Omogućava unos
                    hiddenInput.disabled = false;
                    if (fakeCursor) fakeCursor.style.display = 'inline-block';
                    
                    window.scrollTo(0, 0); 
                    
                    hiddenInput.focus({ preventScroll: true }); 

                    // Dodavanje slušaoca Nivoa 3
                    hiddenInput.addEventListener('input', inputListenerLevel3);
                    hiddenInput.addEventListener('keydown', keypressListenerLevel3);
                });
            }

            // V5 NOVO: Tranzicija na Nivo 4
            function level3SuccessTransitionToLevel4() {
                // 1. Onemogućavanje unosa
                hiddenInput.disabled = true;
                if (fakeCursor) fakeCursor.style.display = 'none';
                hiddenInput.removeEventListener('input', inputListenerLevel3);
                hiddenInput.removeEventListener('keydown', keypressListenerLevel3);
                
                // 2. PRVO ČIŠĆENJE EKRANA (Brzo)
                gameContentDiv.classList.add('hidden'); 
                level2TextDiv.innerHTML = '';
                currentInputRowEl.style.display = 'none';
                terminalContainer.style.display = 'none'; 
                
                window.scrollTo(0, 0); 
                
                // 3. Prikaz "TAČNO!" poruke na celom ekranu
                const successMsgDiv = document.createElement('div');
                successMsgDiv.id = 'success-message-full';
                successMsgDiv.textContent = 'TAČNO!';
                successMsgDiv.className = 'success-message'; 
                successMsgDiv.style.position = 'fixed';
                successMsgDiv.style.width = '100%';
                successMsgDiv.style.height = '100%';
                successMsgDiv.style.backgroundColor = 'black'; 
                
                document.body.appendChild(successMsgDiv);

                // 4. Pauza, pa uklanjanje poruke i DRUGO ČIŠĆENJE EKRANA
                setTimeout(() => {
                    document.body.removeChild(successMsgDiv);
                    
                    // Vraćanje osnovne strukture nakon potpunog čišćenja
                    const oldTerminalContainer = terminalContainer;
                    const oldHiddenInput = hiddenInput;
                    document.body.innerHTML = ''; // POTPUNO ČIŠĆENJE
                    document.body.appendChild(oldTerminalContainer);
                    document.body.appendChild(oldHiddenInput); 
                    oldTerminalContainer.style.display = 'block';
                    
                    // 5. MINI BOOT SEKVENCA ZA NIVO 4
                    bootSequenceDiv.style.display = 'block';
                    bootSequenceDiv.innerHTML = ''; 
                    
                    systemInfo.textContent = 'PRISTUP ODOBREN / NIVO PRISTUPA A4';
                    
                    // Korišćenje LEVEL_4_TRANSITION_MESSAGES. Callback će pokrenuti Level 4 (buduća funkcija)
                    runSequence(bootSequenceDiv, LEVEL_4_TRANSITION_MESSAGES, 0, () => {
                        // 6. TREĆE ČIŠĆENJE EKRANA (Brisanje boot poruka)
                        bootSequenceDiv.style.display = 'none';
                        bootSequenceDiv.innerHTML = '';
                        
                        // 7. Pokretanje Nivoa 4 (trenutno placeholder)
                        startLevel4Placeholder();
                    });
                }, 1000); // Trajanje poruke "TAČNO!"
            }

            // V5 NOVO: Placeholder za početak Nivoa 4
            function startLevel4Placeholder() {
                // Svi elementi su već očišćeni, samo aktiviramo game content sa novim naslovom
                gameContentDiv.classList.remove('hidden');
                
                const placeholderDiv = document.createElement('div');
                placeholderDiv.innerHTML = '<br><br>DOBRODOŠAO U NIVO 4.<br>Spremni za sledeću zagonetku...';
                placeholderDiv.style.textAlign = 'center';
                placeholderDiv.style.marginTop = '50px';
                level2TextDiv.appendChild(placeholderDiv); // Koristimo level2TextDiv za prikaz
                level2TextDiv.classList.remove('hidden');
                
                // Ovo je tačka gde bi se pokrenuo Level 4. Za sada ostaje ovako.
            }
            
            inputListenerLevel3 = (e) => {
                const newInputValue = e.target.value;
                currentInput = newInputValue.toUpperCase();
                displayDiv.textContent = currentInput;
            };

            keypressListenerLevel3 = (e) => {
                if (e.key === 'Enter') {
                    e.preventDefault();

                    const userAnswer = currentInput.trim().toUpperCase();
                    
                    if (CORRECT_ANSWER_LEVEL_3.includes(userAnswer)) {
                        // USPEH: PRELAZAK NA NIVO 4
                        level3SuccessTransitionToLevel4();
                    } 
                    // V10 NOVI USLOV: Provera za Nivo 3 Hint
                    else if (HINT_TRIGGERS_LEVEL_3.includes(userAnswer) && !hintUsedLevel3) {
                        
                        hintUsedLevel3 = true; // Označavamo da je hint dat
                        
                        showFailMessage(HINT_TEXT_LEVEL_3, { flash: false, duration: 7150, alignLeft: true }); // Koristi typeText stil
                        
                        hiddenInput.disabled = true;
                        if (fakeCursor) fakeCursor.style.display = 'none';

                        // Vreme trajanja hint poruke
                        setTimeout(() => {
                            if (typingTimer) { clearTimeout(typingTimer); typingTimer = null; }

                            hiddenInput.disabled = false;
                            if (fakeCursor) fakeCursor.style.display = 'inline-block';

                            currentInput = '';
                            displayDiv.textContent = '';
                            hiddenInput.value = '';
                            hiddenInput.focus();
                        }, 7150); 
                    }
                    else {
                        // NEUSPEH
                        let failMessage = "ODGOVOR POGREŠAN.<br>Pokušajte ponovo.";

                        // Ako je hint već iskorišćen i ponovo se traži
                         if (hintUsedLevel3 && HINT_TRIGGERS_LEVEL_3.includes(userAnswer)) {
                            failMessage = "POMOĆ&nbsp;JE&nbsp;VEĆ&nbsp;DATA!";
                        } 
                        
                        showFailMessage(failMessage, { flash: false, duration: 1500 }); // Uvek zelena za Nivo 3 greške/hint poruke
                        currentInput = '';
                        displayDiv.textContent = '';
                        hiddenInput.value = '';
                        hiddenInput.focus();
                    }
                }
            };

            // =================================================================
            // NIVO 1 LOGIKA (Koristi hintUsedLevel1)
            // =================================================================

            inputListenerLevel1 = (e) => {
                const newInputValue = e.target.value;
                currentInput = newInputValue.toUpperCase();
                displayDiv.textContent = currentInput;
            };

            keypressListenerLevel1 = (e) => {
                if (e.key === 'Enter') {
                    e.preventDefault();

                    // Čišćenje feedback-a
                    if (failTimer) { clearTimeout(failTimer); failTimer = null; }
                    if (typingTimer) { clearTimeout(typingTimer); typingTimer = null; }
                    if (failDiv) {
                        failDiv.classList.add('hidden');
                        failDiv.style.display = 'none';
                        failDiv.innerHTML = '';
                    }

                    const userAnswer = currentInput.trim().toUpperCase();

                    if (CORRECT_ANSWERS.includes(userAnswer)) {
                        hiddenInput.disabled = true;
                        if (fakeCursor) fakeCursor.style.display = 'none';

                        hiddenInput.removeEventListener('input', inputListenerLevel1);
                        hiddenInput.removeEventListener('keydown', keypressListenerLevel1);

                        terminalContainer.classList.add('flash-red');

                        setTimeout(() => {
                            terminalContainer.classList.remove('flash-red');
                            accessGranted(); // Poziva Level 2
                        }, 300);

                    } 
                    // V6 NOVI USLOV: Provera da li je uneta reč za pomoć i da li hint nije iskorišćen
                    else if (HINT_TRIGGERS.includes(userAnswer) && !hintUsedLevel1) {
                        
                        hintUsedLevel1 = true; // Označavamo da je hint dat
                        
                        // Hint tekst se kuca polako
                        typeText(failDiv, HINT_TEXT, 50);
                        
                        // Zbog sporog kucanja, ne koristimo showFailMessage, već prilagođavamo stil ručno:
                        failDiv.style.textAlign = 'left'; 
                        failDiv.style.maxWidth = '80%';
                        failDiv.style.color = '#00FF00'; 
                        
                        hiddenInput.disabled = true;
                        if (fakeCursor) fakeCursor.style.display = 'none';

                        // Vreme trajanja hint poruke
                        setTimeout(() => {
                            if (typingTimer) { clearTimeout(typingTimer); typingTimer = null; }

                            if (failDiv) {
                                failDiv.classList.add('hidden');
                                failDiv.style.display = 'none';
                                failDiv.innerHTML = '';
                            }
                            
                            // Vraćanje stila na default
                            failDiv.style.textAlign = 'center'; 
                            failDiv.style.maxWidth = '90%';
                            
                            hiddenInput.disabled = false;
                            if (fakeCursor) fakeCursor.style.display = 'inline-block';

                            currentInput = '';
                            displayDiv.textContent = '';
                            hiddenInput.value = '';
                            hiddenInput.focus();
                        }, 7150); // Trajanje hint poruke

                    } 
                    else {
                        // Tretiranje pogrešnog unosa/unosa pomoći nakon što je Hint već dat
                        attemptCount++;
                        
                        if (attemptCount >= MAX_ATTEMPTS) {
                            showFailMessage("PRISTUP&nbsp;ODBIJEN!<br>SISTEM&nbsp;SE&nbsp;RESETUJE!", { flash: true, duration: 2400 });
                            hiddenInput.disabled = true;
                            if (fakeCursor) fakeCursor.style.display = 'none';
                            setTimeout(resetSystem, 2500);

                        } else {
                            // Zelena poruka bez bljeska
                            let failMessage = "PRISTUP&nbsp;ODBIJEN!<br>Pokusajte&nbsp;ponovo.";
                            
                            // V7 IZMENA: Samo ispisujemo poruku da je pomoć već data ako je iskorišćena
                            if (hintUsedLevel1 && HINT_TRIGGERS.includes(userAnswer)) {
                                failMessage = "POMOĆ&nbsp;JE&nbsp;VEĆ&nbsp;DATA!";
                            } 
                            // Ostatak pogrešnih pokušaja dobija samo "PRISTUP ODBIJEN..." bez sugestije

                            showFailMessage(failMessage, { flash: false, duration: 1500 });
                            
                            currentInput = '';
                            displayDiv.textContent = '';
                            hiddenInput.value = '';
                            hiddenInput.focus();
                        }
                    }
                }
            };
            
            // =================================================================
            // NIVO 2 LOGIKA 
            // =================================================================
            
            inputListenerLevel2 = (e) => {
                const newInputValue = e.target.value;
                currentInput = newInputValue.toUpperCase();
                // Ograničavanje unosa na 2 slova (DA/NE)
                if (currentInput.length > 2) {
                    currentInput = currentInput.substring(0, 2);
                    e.target.value = currentInput;
                }
                displayDiv.textContent = currentInput;
            };
            
            keypressListenerLevel2 = (e) => {
                if (e.key === 'Enter') {
                    e.preventDefault();

                    const userAnswer = currentInput.trim().toUpperCase();
                    
                    if (userAnswer === 'DA') {
                        // PRELAZAK NA NIVO 3 (ZAGONETKU)
                        hiddenInput.disabled = true;
                        if (fakeCursor) fakeCursor.style.display = 'none';
                        currentInput = '';
                        displayDiv.textContent = '';
                        hiddenInput.value = '';
                        
                        // UKLANJANJE PORUKE I POZIV NOVE SEKVENCIJE
                        successDiv.classList.add('hidden');
                        successDiv.innerHTML = '';

                        // Pokreće novu loading sekvencu koja vodi u Level 3
                        loadLevel3WithBootSequence();
                        
                    } else if (userAnswer === 'NE') {
                        // *** IZMENA: Pokretanje sekvence gašenja sistema ***
                        // Kratka zelena potvrda pre tranzicije
                        showFailMessage("ODGOVOR PRIHVAĆEN. STATUS: OFFLINE.", { flash: false, duration: 500 });
                        
                        // Onemogućavanje unosa
                        hiddenInput.disabled = true;
                        if (fakeCursor) fakeCursor.style.display = 'none';
                        
                        setTimeout(startShutdownSequence, 600); // Pozivanje funkcije gašenja

                    } else {
                        // Neispravan unos
                        showFailMessage("NEVAŽEĆI UNOS!<br>Molimo&nbsp;unesite&nbsp;DA&nbsp;ili&nbsp;NE.", { flash: true, duration: 1500 });
                        currentInput = '';
                        displayDiv.textContent = '';
                        hiddenInput.value = '';
                        hiddenInput.focus();
                    }
                }
            };
            
            // =================================================================
            // OPŠTE FUNKCIJE 
            // =================================================================

            function resetSystem() {
                if (typingTimer) { clearTimeout(typingTimer); typingTimer = null; }
                if (failTimer) { clearTimeout(failTimer); failTimer = null; }
                
                // Vraćanje body stila na default 
                document.body.innerHTML = ''; // Potpuno čišćenje tela
                document.body.appendChild(terminalContainer); // Vraćanje glavnog kontejnera
                document.body.appendChild(hiddenInput); // Vraćanje inputa

                document.body.style.color = '#00FF00';
                document.body.style.overflow = 'auto';
                document.body.style.textShadow = '0 0 5px rgba(0, 255, 0, 0.7), 0 0 10px rgba(0, 255, 0, 0.3)';
                document.body.style.backgroundColor = '#000000';


                terminalContainer.style.display = 'block'; // Vraćanje prikaza glavnog kontejnera
                terminalContainer.classList.remove('flash-red');
                gameContentDiv.classList.add('hidden'); // Skriva CEO sadržaj
                bootSequenceDiv.style.display = 'block';
                bootSequenceDiv.innerHTML = '';

                attemptCount = 0;
                currentInput = '';
                displayDiv.textContent = '';
                hiddenInput.value = '';
                hiddenInput.disabled = false;
                
                // Resetovanje stanja hint-a
                hintUsedLevel1 = false; 
                hintUsedLevel3 = false; // V10: Reset Level 3 hint

                if (fakeCursor) fakeCursor.style.display = 'inline-block';

                if (failDiv) {
                    failDiv.classList.remove('fail-flash');
                    failDiv.classList.add('hidden');
                    failDiv.style.display = 'none';
                    failDiv.innerHTML = '';
                    failDiv.style.color = '#00FF00';
                    // Resetovanje stila za hint
                    failDiv.style.textAlign = 'center'; 
                    failDiv.style.maxWidth = '90%'; 
                }
                if (successDiv) {
                    successDiv.classList.add('hidden');
                    successDiv.style.display = 'none';
                    successDiv.innerHTML = '';
                }
                
                // Osigurava da se klasa za min-height ukloni pri resetu
                level2TextDiv.classList.remove('level-2-space'); 
                level2TextDiv.classList.add('hidden');
                level2TextDiv.innerHTML = '';


                if (gameTitle) gameTitle.style.color = '#FF0000';
                if (systemInfo) systemInfo.textContent = 'SISTEM 1101 / VER. 2.6';
                if (inputPromptText) inputPromptText.textContent = 'Unesite šifru:';

                if (currentInputRowEl) {
                    currentInputRowEl.classList.remove('hidden');
                    currentInputRowEl.style.display = 'flex';
                }
                
                // Dodavanje slušaoca Nivoa 1 i uklanjanje svih ostalih
                hiddenInput.removeEventListener('input', inputListenerLevel1);
                hiddenInput.removeEventListener('keydown', keypressListenerLevel1);
                hiddenInput.removeEventListener('input', inputListenerLevel2);
                hiddenInput.removeEventListener('keydown', keypressListenerLevel2);
                hiddenInput.removeEventListener('input', inputListenerLevel3);
                hiddenInput.removeEventListener('keydown', keypressListenerLevel3);
                
                hiddenInput.addEventListener('input', inputListenerLevel1);
                hiddenInput.addEventListener('keydown', keypressListenerLevel1);

                runSequence(bootSequenceDiv, bootMessages, 0, () => {
                    // Originalni završetak boot-a (Nivo 1, poziva se na startu ili resetu)
                    bootSequenceDiv.style.display = 'none';
                    gameContentDiv.classList.remove('hidden'); 
                    level2TextDiv.classList.add('hidden'); 
                    level2TextDiv.innerHTML = '';
                    level2TextDiv.classList.add('level-2-space'); 
                    currentInputRowEl.classList.remove('hidden');
                    currentInputRowEl.style.display = 'flex';
                    inputPromptText.textContent = 'Unesite šifru:';
                    hiddenInput.focus({ preventScroll: true }); 
                });
            }


            // Pokretanje inicijalne sekvence pri učitavanju
            hiddenInput.removeEventListener('input', inputListenerLevel1);
            hiddenInput.removeEventListener('keydown', keypressListenerLevel2);
            hiddenInput.removeEventListener('keydown', keypressListenerLevel1);
            hiddenInput.removeEventListener('input', inputListenerLevel3);
            hiddenInput.removeEventListener('keydown', keypressListenerLevel3);
            hiddenInput.addEventListener('input', inputListenerLevel1);
            hiddenInput.addEventListener('keydown', keypressListenerLevel1);

            // Pokreće prvu sekvencu u bootSequenceDiv
            runSequence(bootSequenceDiv, bootMessages, 0, () => {
                bootSequenceDiv.style.display = 'none';
                gameContentDiv.classList.remove('hidden');
                hiddenInput.focus({ preventScroll: true });
            });

            document.body.addEventListener('click', () => {
                if (!hiddenInput.disabled) {
                    // Fokusiranje na klik uz sprečavanje skrola
                    hiddenInput.focus({ preventScroll: true }); 
                }
            });
        });
    </script>
</body>
</html>
