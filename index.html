<script>
        document.addEventListener('DOMContentLoaded', () => {
            // ... (Deklaracije promenljivih su iste kao V48.9) ...
            const terminalDiv = document.getElementById('terminal');
            const outputDiv = document.getElementById('output');
            const promptSpan = document.getElementById('prompt');
            const currentLineDiv = document.getElementById('currentLine'); 
            const userInputDisplay = document.getElementById('userInputDisplay');
            const hiddenInput = document.getElementById('hiddenInput'); 
            
            let inputActive = false; 
            let gamePhase = 1; 
            let currentInput = ""; 
            
            const CORRECT_LOGIN = "observer"; 
            
            // ... (Funkcije za ispis, faze i handleRiddleX su iste kao V48.9) ...

            // Pomoćna funkcija za obrtanje stringa
            function reverseString(str) {
                return str.split('').reverse().join('');
            }

            function activateInput(phase) {
                // ... (Logika activateInput je ista kao V48.9) ...
                gamePhase = phase;
                if (phase === 1) promptSpan.textContent = "Login: ";
                if (phase === 2) promptSpan.textContent = ">> ";
                // ... (ostali promptovi) ...
                
                if (phase < 11) {
                    currentLineDiv.style.display = 'flex'; 
                    inputActive = true; 
                    currentInput = ""; 
                    hiddenInput.value = ""; 
                    userInputDisplay.textContent = "";

                    setTimeout(() => {
                        hiddenInput.focus();
                        terminalDiv.scrollTop = terminalDiv.scrollHeight;
                    }, 50); 
                } else {
                    currentLineDiv.style.display = 'none';
                    inputActive = false;
                }
            }

            // ... (Handle funkcije su iste kao V48.9) ...
            
            const processInput = (fullInput) => {
                // ... (Logika processInput je ista kao V48.9) ...
                if (!inputActive) return; 
                inputActive = false; 
                const inputLower = fullInput.trim().toLowerCase();
                outputText(`${promptSpan.textContent}${fullInput}`);
                
                if (gamePhase === 1) { handleLogin(inputLower); } 
                else if (gamePhase === 2) { handleYesNo(inputLower); } 
                // ... (ostali gamePhase) ...
            };
            
            // NOVI HANDLER - Ponavlja fokus ako se izgubi
            const blurHandler = () => {
                if (inputActive && isMobileDevice()) {
                    setTimeout(() => {
                        hiddenInput.focus();
                    }, 1);
                }
            };
            hiddenInput.addEventListener('blur', blurHandler);
            
            // Standardni keydown za desktop
            const keydownHandler = (e) => {
                if (!inputActive) return; 
                
                if (!isMobileDevice()) {
                    // DESKTOP LOGIKA - Preuzima karakter po karakter i sinhronizuje hiddenInput
                    if (e.key.length === 1 && e.key.match(/^[a-zA-Z0-9\s.,!?-]$/)) { 
                        e.preventDefault(); 
                        currentInput += e.key;
                        hiddenInput.value = currentInput; 
                        userInputDisplay.textContent = currentInput;
                    } else if (e.key === 'Backspace') {
                        e.preventDefault(); 
                        currentInput = currentInput.slice(0, -1);
                        hiddenInput.value = currentInput; 
                        userInputDisplay.textContent = currentInput;
                    } else if (e.key === 'Enter') {
                        e.preventDefault();
                        processInput(currentInput);
                    }
                    terminalDiv.scrollTop = terminalDiv.scrollHeight;
                    return; 
                }
                
                // Mobilni samo čeka Enter (koji se često ne generiše),
                // ali na tastaturama sa Enter/Go tasterom
                if (e.key === 'Enter') {
                    e.preventDefault();
                    processInput(currentInput);
                }
            };
            document.addEventListener('keydown', keydownHandler);

            // KRITIČNI INPUT HANDLER ZA MOBILNI
            const inputHandler = () => {
                if (!inputActive) return; 
                
                let rawInput = hiddenInput.value; 
                
                // *** KRITIČNA KOREKCIJA ZA OBRNUTI UNOS ***
                let displayInput = rawInput;
                if (isMobileDevice()) {
                    // Jednostavna heuristika: ako je input duži od 1 i kuca unazad, obrnemo ga.
                    // Ovo bi trebalo da reši problem obrnutog unosa.
                    // OBRNUTI string:
                    displayInput = reverseString(rawInput);
                    
                    // Ovo je čista spekulacija, ali ako je input "revresbo", ispravan string je "observer"
                    // Takođe, moramo biti sigurni da je currentInput ispravan string za obradu.
                    currentInput = displayInput;
                } else {
                    currentInput = rawInput;
                }
                
                userInputDisplay.textContent = currentInput;
                
                if (isMobileDevice()) {
                    hiddenInput.focus();
                }
            };
            hiddenInput.addEventListener('input', inputHandler);

            // Handler za submitovanje na mobilnom
            const mobileChangeHandler = () => {
                 if (isMobileDevice() && inputActive) {
                    processInput(currentInput);
                 }
            }
            hiddenInput.addEventListener('change', mobileChangeHandler); 

            // Klik na terminal vraća fokus
            const clickHandler = (e) => {
                if (!inputActive) return; 
                e.preventDefault(); 
                hiddenInput.focus();
            };
            terminalDiv.addEventListener('click', clickHandler);
            
            startBootSequence();
        });
    </script>
</body>
</html>
